<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buxgalteriya va Qarz Nazorati - Davr Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="loader" class="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-700 mb-4"></div>
        <p id="loaderText" class="text-gray-600 font-medium text-center px-4">Firebase ulanmoqda...</p>
    </div>

    <!-- Navigatsiya -->
    <nav class="bg-blue-700 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold tracking-tight text-white italic">Davr-Nazorat <span class="text-blue-200">Pro</span></h1>
            <div class="space-x-2 md:space-x-4 flex">
                <button onclick="showTab('dashboard')" class="hover:bg-blue-600 px-3 py-1 rounded-lg transition font-medium text-sm md:text-base">Hisobotlar</button>
                <button onclick="showTab('customers')" class="hover:bg-blue-600 px-3 py-1 rounded-lg transition font-medium text-sm md:text-base">Mijozlar</button>
                <button onclick="showTab('sales')" class="hover:bg-blue-600 px-3 py-1 rounded-lg transition font-medium text-sm md:text-base">Tarix</button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 md:p-6">
        <!-- DASHBOARD (Hisobotlar) -->
        <div id="dashboard" class="tab-content active space-y-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-blue-500">
                    <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">Mijozlar soni</p>
                    <h2 id="customerCount" class="text-2xl font-black mt-1">0</h2>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-red-500">
                    <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">Umumiy Qarzlar</p>
                    <h2 id="totalDebts" class="text-2xl font-black mt-1 text-red-600">0 so'm</h2>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-green-500">
                    <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">Jami Savdo</p>
                    <h2 id="totalSalesAmount" class="text-2xl font-black mt-1">0 so'm</h2>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-purple-500">
                    <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">Jami To'lovlar</p>
                    <h2 id="totalPaymentsAmount" class="text-2xl font-black mt-1">0 so'm</h2>
                </div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">Tizim holati muvaffaqiyatli!</h3>
                <p class="text-center text-gray-500">Mijozlar va savdolarni boshqarish uchun tegishli bo'limlarga o'ting.</p>
            </div>
        </div>

        <!-- MIJOZLAR -->
        <div id="customers" class="tab-content space-y-4">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <h2 class="text-2xl font-black text-gray-800">Mijozlar</h2>
                <div class="flex gap-2 w-full md:w-auto">
                    <input type="text" id="customerSearch" oninput="window.renderAll()" placeholder="Qidiruv..." class="border border-gray-200 p-2 pl-4 rounded-xl w-full md:w-64 outline-none">
                    <button onclick="openModal('customerModal')" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold shadow-md">+ Yangi</button>
                </div>
            </div>
            <div class="overflow-x-auto bg-white rounded-2xl shadow-sm border border-gray-100">
                <table class="w-full text-left border-collapse min-w-[600px]">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-4 text-xs font-bold text-gray-400 uppercase">Mijoz</th>
                            <th class="p-4 text-xs font-bold text-gray-400 uppercase">Telefon</th>
                            <th class="p-4 text-xs font-bold text-gray-400 uppercase">Qarz</th>
                            <th class="p-4 text-xs font-bold text-gray-400 uppercase text-right">Amal</th>
                        </tr>
                    </thead>
                    <tbody id="customerList"></tbody>
                </table>
            </div>
        </div>

        <!-- TARIX -->
        <div id="sales" class="tab-content space-y-4">
            <h2 class="text-2xl font-black text-gray-800">Tarix</h2>
            <div class="overflow-x-auto bg-white rounded-2xl shadow-sm border border-gray-100">
                <table class="w-full text-left border-collapse min-w-[600px]">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-4 text-xs font-bold text-gray-400 uppercase">Sana</th>
                            <th class="p-4 text-xs font-bold text-gray-400 uppercase">Mijoz</th>
                            <th class="p-4 text-xs font-bold text-gray-400 uppercase">Mahsulot</th>
                            <th class="p-4 text-xs font-bold text-gray-400 uppercase">Summa</th>
                            <th class="p-4 text-xs font-bold text-gray-400 uppercase">Tur</th>
                        </tr>
                    </thead>
                    <tbody id="salesHistoryTable"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- YANGI MIJOZ MODAL -->
    <div id="customerModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center p-4 z-[60] backdrop-blur-sm">
        <div class="bg-white rounded-2xl max-w-md w-full p-8 shadow-2xl">
            <h3 class="text-xl font-black mb-6">ðŸ‘¤ Yangi Mijoz</h3>
            <div class="space-y-4">
                <input type="text" id="custName" placeholder="Mijoz ismi" class="w-full border p-3 rounded-xl outline-none">
                <input type="text" id="custPhone" placeholder="Telefon" class="w-full border p-3 rounded-xl outline-none">
                <input type="text" id="custFirstItem" placeholder="Mahsulot nomi" class="w-full border p-3 rounded-xl outline-none">
                <input type="number" id="custTotalAmount" placeholder="Jami summa (Nasiya)" class="w-full border p-3 rounded-xl outline-none">
                <input type="number" id="custPaidAmount" placeholder="To'lov summasi (Hozirgi)" class="w-full border p-3 rounded-xl outline-none">
                <div class="flex gap-3 mt-6">
                    <button onclick="closeModal('customerModal')" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold">Bekor</button>
                    <button id="saveCustomerBtn" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold">Saqlash</button>
                </div>
            </div>
        </div>
    </div>

    <!-- QARZ TO'LOVI MODAL -->
    <div id="paymentModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center p-4 z-[60] backdrop-blur-sm">
        <div class="bg-white rounded-2xl max-w-md w-full p-8 shadow-2xl">
            <h3 class="text-xl font-black mb-6">ðŸ’¸ Qarz To'lovi</h3>
            <div class="space-y-4">
                <p id="paymentTargetName" class="font-bold text-blue-700"></p>
                <input type="number" id="paymentAmount" placeholder="To'lov summasi" class="w-full border p-3 rounded-xl outline-none text-xl font-bold">
                <div class="flex gap-3">
                    <button onclick="closeModal('paymentModal')" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold">Bekor</button>
                    <button id="confirmPaymentBtn" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold">Saqlash</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyATxcw1JwtS1rixD1eUm0yJzcESeeQLQnw", 
            authDomain: "davr-pro-v1.firebaseapp.com",
            projectId: "davr-pro-v1",
            storageBucket: "davr-pro-v1.appspot.com",
            messagingSenderId: "36531388654",
            appId: "1:36531388654:web:03f7e6144e537442df1e53"
        };

        const appId = 'davr-pro-v1';
        let db, auth;

        const showError = (msg) => {
            const loaderText = document.getElementById('loaderText');
            if(loaderText) {
                loaderText.innerHTML = `<div class="bg-red-50 p-4 rounded-lg border border-red-200">
                    <span class="text-red-600 font-bold">Xatolik yuz berdi:</span><br>
                    <span class="text-sm text-red-500">${msg}</span><br>
                    <button onclick="location.reload()" class="mt-2 bg-red-600 text-white px-4 py-1 rounded text-xs">Qayta yuklash</button>
                </div>`;
            }
        };

        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Timeout - agar 10 soniyada ulanmasa xato ko'rsatadi
            const timeout = setTimeout(() => {
                showError("Ulanish vaqti tugadi. Internetingizni yoki Firebase Rules'ni tekshiring.");
            }, 10000);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    clearTimeout(timeout);
                    document.getElementById('loader').classList.add('hidden');
                    startSync();
                } else {
                    await signInAnonymously(auth).catch(e => {
                        clearTimeout(timeout);
                        showError("Auth xatosi: " + e.message + ". Firebase Console-da Anonymous Auth yoqilganini tekshiring.");
                    });
                }
            });

            function startSync() {
                // Real-time listener for customers
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'customers'), (snap) => {
                    window.customersData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    window.renderAll();
                }, (err) => {
                    showError("Firestore (Customers) xatosi: " + err.message);
                });

                // Real-time listener for sales
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'sales'), (snap) => {
                    window.salesData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    window.renderAll();
                }, (err) => {
                    showError("Firestore (Sales) xatosi: " + err.message);
                });
            }

            window.customersData = [];
            window.salesData = [];

            // UI logic
            window.showTab = (id) => {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.getElementById(id).classList.add('active');
            };

            window.openModal = (id, targetId = null) => {
                document.getElementById(id).classList.remove('hidden');
                if (id === 'paymentModal' && targetId) {
                    window.activeCustomerId = targetId;
                    const c = window.customersData.find(x => x.id === targetId);
                    document.getElementById('paymentTargetName').innerText = c ? c.name + " uchun to'lov" : '';
                }
            };

            window.closeModal = (id) => {
                document.getElementById(id).classList.add('hidden');
            };

            document.getElementById('saveCustomerBtn').onclick = async () => {
                const name = document.getElementById('custName').value;
                const phone = document.getElementById('custPhone').value;
                const item = document.getElementById('custFirstItem').value || 'Dastlabki savdo';
                const total = parseFloat(document.getElementById('custTotalAmount').value) || 0;
                const paid = parseFloat(document.getElementById('custPaidAmount').value) || 0;
                
                if (!name) return alert("Ismni kiritish shart!");

                try {
                    const custRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'customers'), {
                        name, phone, totalDebt: total - paid, createdAt: serverTimestamp()
                    });

                    if (total > 0) {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'sales'), {
                            customerId: custRef.id, item, amount: total, type: 'sale', date: new Date().toISOString()
                        });
                    }
                    if (paid > 0) {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'sales'), {
                            customerId: custRef.id, item: 'Boshlang\'ich to\'lov', amount: paid, type: 'payment', date: new Date().toISOString()
                        });
                    }
                    closeModal('customerModal');
                    ['custName', 'custPhone', 'custFirstItem', 'custTotalAmount', 'custPaidAmount'].forEach(i => document.getElementById(i).value = '');
                } catch(e) { alert("Xato: " + e.message); }
            };

            document.getElementById('confirmPaymentBtn').onclick = async () => {
                const amount = parseFloat(document.getElementById('paymentAmount').value);
                if (!amount || !window.activeCustomerId) return;
                try {
                    const c = window.customersData.find(x => x.id === window.activeCustomerId);
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'sales'), {
                        customerId: window.activeCustomerId, item: 'Qarz to\'lovi', amount, type: 'payment', date: new Date().toISOString()
                    });
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'customers', window.activeCustomerId), {
                        totalDebt: (c.totalDebt || 0) - amount
                    });
                    closeModal('paymentModal');
                    document.getElementById('paymentAmount').value = '';
                } catch(e) { alert("Xato: " + e.message); }
            };

            window.renderAll = () => {
                const search = document.getElementById('customerSearch').value.toLowerCase();
                
                // Stats
                document.getElementById('customerCount').innerText = window.customersData.length;
                document.getElementById('totalDebts').innerText = window.customersData.reduce((a, b) => a + (b.totalDebt || 0), 0).toLocaleString() + " so'm";
                document.getElementById('totalSalesAmount').innerText = window.salesData.filter(s => s.type === 'sale').reduce((a, b) => a + (b.amount || 0), 0).toLocaleString() + " so'm";
                document.getElementById('totalPaymentsAmount').innerText = window.salesData.filter(s => s.type === 'payment').reduce((a, b) => a + (b.amount || 0), 0).toLocaleString() + " so'm";

                // List
                document.getElementById('customerList').innerHTML = window.customersData
                    .filter(c => (c.name || '').toLowerCase().includes(search))
                    .map(c => `
                        <tr class="border-t hover:bg-gray-50">
                            <td class="p-4 font-bold text-blue-900">${c.name}</td>
                            <td class="p-4 text-gray-600">${c.phone || '-'}</td>
                            <td class="p-4 text-red-600 font-bold">${(c.totalDebt || 0).toLocaleString()}</td>
                            <td class="p-4 text-right">
                                <button onclick="openModal('paymentModal', '${c.id}')" class="bg-blue-600 text-white px-4 py-1 rounded-lg text-xs font-bold transition-all active:scale-95 shadow-sm">To'lov</button>
                            </td>
                        </tr>`).join('');

                // History
                document.getElementById('salesHistoryTable').innerHTML = window.salesData
                    .sort((a,b) => new Date(b.date) - new Date(a.date))
                    .map(s => {
                        const c = window.customersData.find(x => x.id === s.customerId);
                        return `
                        <tr class="border-t text-sm">
                            <td class="p-4 text-gray-400 font-mono">${new Date(s.date).toLocaleDateString()}</td>
                            <td class="p-4 font-semibold">${c ? c.name : 'Noma\'lum'}</td>
                            <td class="p-4 italic text-gray-600">${s.item}</td>
                            <td class="p-4 font-bold">${(s.amount || 0).toLocaleString()}</td>
                            <td class="p-4"><span class="px-2 py-1 rounded text-[10px] font-black ${s.type === 'sale' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">${s.type === 'sale' ? 'NASIYA' : 'TO\'LOV'}</span></td>
                        </tr>`;
                    }).join('');
            };

        } catch (e) {
            showError("Tizimni yuklashda jiddiy xato: " + e.message);
        }
    </script>
</body>
</html>
