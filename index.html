<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buxgalteriya va Qarz Nazorati - Davr Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Yuklanish ekrani -->
    <div id="loader" class="loading-overlay">
        <div id="loader-spinner" class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-700 mb-4"></div>
        <p id="loader-text" class="text-blue-700 font-bold text-center px-4">Tizimga ulanmoqda...</p>
        <button id="retry-btn" onclick="location.reload()" class="hidden mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg">Qayta urinish</button>
    </div>

    <!-- Navigatsiya -->
    <nav class="bg-blue-700 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold tracking-tight text-white italic">Davr-Nazorat <span class="text-blue-200">Pro</span></h1>
            <div class="space-x-2 md:space-x-4 flex">
                <button onclick="showTab('dashboard')" class="hover:bg-blue-600 px-3 py-1 rounded-lg transition font-medium text-sm md:text-base">Hisobotlar</button>
                <button onclick="showTab('customers')" class="hover:bg-blue-600 px-3 py-1 rounded-lg transition font-medium text-sm md:text-base">Mijozlar</button>
                <button onclick="showTab('sales')" class="hover:bg-blue-600 px-3 py-1 rounded-lg transition font-medium text-sm md:text-base">Tarix</button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 md:p-6">
        <!-- DASHBOARD -->
        <div id="dashboard" class="tab-content active space-y-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-blue-500">
                    <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">Bugungi savdo</p>
                    <h2 id="todaySales" class="text-2xl font-black mt-1">0 so'm</h2>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-red-500">
                    <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">Umumiy Qarzlar</p>
                    <h2 id="totalDebts" class="text-2xl font-black mt-1 text-red-600">0 so'm</h2>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-green-500">
                    <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">Haftalik savdo</p>
                    <h2 id="weeklySales" class="text-2xl font-black mt-1">0 so'm</h2>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-purple-500">
                    <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">Oylik savdo</p>
                    <h2 id="monthlySales" class="text-2xl font-black mt-1">0 so'm</h2>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="text-lg font-bold text-gray-800 mb-6">Savdo dinamikasi (Oxirgi 7 kun)</h3>
                <div class="relative h-[300px]">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>
        </div>

        <!-- MIJOZLAR -->
        <div id="customers" class="tab-content space-y-4">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <h2 class="text-2xl font-black text-gray-800">Mijozlar</h2>
                <div class="flex gap-2 w-full md:w-auto">
                    <input type="text" id="customerSearch" placeholder="Qidiruv..." class="border border-gray-200 p-2 pl-4 rounded-xl w-full md:w-64 outline-none">
                    <button onclick="openModal('customerModal')" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold">+ Yangi</button>
                </div>
            </div>
            <div class="overflow-x-auto bg-white rounded-2xl shadow-sm border border-gray-100">
                <table class="w-full text-left border-collapse min-w-[600px]">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-4 text-xs font-bold text-gray-400 uppercase">Mijoz</th>
                            <th class="p-4 text-xs font-bold text-gray-400 uppercase">Telefon</th>
                            <th class="p-4 text-xs font-bold text-gray-400 uppercase">Qarz</th>
                            <th class="p-4 text-xs font-bold text-gray-400 uppercase text-right">Amal</th>
                        </tr>
                    </thead>
                    <tbody id="customerList"></tbody>
                </table>
            </div>
        </div>

        <!-- TARIX -->
        <div id="sales" class="tab-content space-y-4">
            <h2 class="text-2xl font-black text-gray-800">Tarix</h2>
            <div class="overflow-x-auto bg-white rounded-2xl shadow-sm border border-gray-100">
                <table class="w-full text-left border-collapse min-w-[600px]">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-4 text-xs font-bold text-gray-400 uppercase">Sana</th>
                            <th class="p-4 text-xs font-bold text-gray-400 uppercase">Mijoz</th>
                            <th class="p-4 text-xs font-bold text-gray-400 uppercase">Mahsulot</th>
                            <th class="p-4 text-xs font-bold text-gray-400 uppercase">Summa</th>
                            <th class="p-4 text-xs font-bold text-gray-400 uppercase">Tur</th>
                        </tr>
                    </thead>
                    <tbody id="salesHistoryTable"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- MODALLAR -->
    <div id="customerModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center p-4 z-[60] backdrop-blur-sm">
        <div class="bg-white rounded-2xl max-w-md w-full p-8 shadow-2xl">
            <h3 class="text-xl font-black mb-6">ðŸ‘¤ Yangi Mijoz</h3>
            <div class="space-y-4">
                <input type="text" id="custName" placeholder="Mijoz ismi" class="w-full border p-3 rounded-xl outline-none">
                <input type="text" id="custPhone" placeholder="Telefon" class="w-full border p-3 rounded-xl outline-none">
                <input type="text" id="custFirstItem" placeholder="Mahsulot nomi" class="w-full border p-3 rounded-xl outline-none">
                <input type="number" id="custTotalAmount" placeholder="Jami summa" class="w-full border p-3 rounded-xl outline-none">
                <input type="number" id="custPaidAmount" placeholder="To'lov summasi" class="w-full border p-3 rounded-xl outline-none">
                <div class="flex gap-3 mt-6">
                    <button onclick="closeModal('customerModal')" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold">Bekor</button>
                    <button id="saveCustomerBtn" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold">Saqlash</button>
                </div>
            </div>
        </div>
    </div>

    <div id="paymentModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center p-4 z-[60] backdrop-blur-sm">
        <div class="bg-white rounded-2xl max-w-md w-full p-8 shadow-2xl">
            <h3 class="text-xl font-black mb-6">ðŸ’¸ Qarz To'lovi</h3>
            <div class="space-y-4">
                <p id="paymentTargetName" class="font-bold text-blue-700"></p>
                <input type="number" id="paymentAmount" placeholder="To'lov summasi" class="w-full border p-3 rounded-xl outline-none text-xl font-bold">
                <div class="flex gap-3">
                    <button onclick="closeModal('paymentModal')" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold">Bekor</button>
                    <button id="confirmPaymentBtn" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold">Saqlash</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase konfiguratsiyasi - Siz bergan ma'lumotlar
        const firebaseConfig = {
            apiKey: "AIzaSyATxcw1JwtS1rixD1eUm0yJzcESeeQLQnw",
            authDomain: "meningbuxgalteriyam.firebaseapp.com",
            projectId: "meningbuxgalteriyam",
            storageBucket: "meningbuxgalteriyam.firebasestorage.app",
            messagingSenderId: "358385708799",
            appId: "1:358385708799:web:38c7d59f157bb1a269e6ca",
            measurementId: "G-X1NDN28KBK"
        };

        const appId = 'mening-buxgalteriyam-v1';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let customersData = [];
        let salesData = [];
        let activeCustomerId = null;
        let chartInstance = null;

        const showError = (msg) => {
            document.getElementById('loader-text').innerHTML = `<span class="text-red-600">Xatolik: ${msg}</span>`;
            document.getElementById('loader-spinner').classList.add('hidden');
            document.getElementById('retry-btn').classList.remove('hidden');
        };

        const initAuth = async () => {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth xatosi:", error);
                showError("Firebase-da 'Anonymous Auth' yoqilmagan bo'lishi mumkin.");
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Tizimga kirildi:", user.uid);
                startSync();
            } else {
                initAuth();
            }
        });

        function startSync() {
            // Firestore path qoidasiga muvofiq (RULE 1)
            const customersRef = collection(db, 'artifacts', appId, 'public', 'data', 'customers');
            const salesRef = collection(db, 'artifacts', appId, 'public', 'data', 'sales');

            let loaded = 0;
            const checkLoad = () => {
                loaded++;
                if (loaded >= 2) document.getElementById('loader').classList.add('hidden');
            };

            onSnapshot(customersRef, (snap) => {
                customersData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                window.renderAll();
                checkLoad();
            }, (err) => showError("Firestore Rules-da o'qishga ruxsat yo'q"));

            onSnapshot(salesRef, (snap) => {
                salesData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                window.renderAll();
                checkLoad();
            }, (err) => console.error(err));
        }

        window.showTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.openModal = (id, targetId = null) => {
            document.getElementById(id).classList.remove('hidden');
            if (id === 'paymentModal') {
                activeCustomerId = targetId;
                const c = customersData.find(x => x.id === targetId);
                document.getElementById('paymentTargetName').innerText = c ? c.name : '';
                document.getElementById('paymentAmount').value = '';
            }
        };

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        document.getElementById('customerSearch').addEventListener('input', () => window.renderAll());

        document.getElementById('saveCustomerBtn').onclick = async () => {
            if (!auth.currentUser) return;
            const name = document.getElementById('custName').value.trim();
            const phone = document.getElementById('custPhone').value.trim();
            const item = document.getElementById('custFirstItem').value || 'Dastlabki xarid';
            const total = parseFloat(document.getElementById('custTotalAmount').value) || 0;
            const paid = parseFloat(document.getElementById('custPaidAmount').value) || 0;
            const qarz = total - paid;

            if (!name) return;

            try {
                const custRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'customers'), {
                    name, phone, totalDebt: qarz, createdAt: serverTimestamp()
                });

                if (total > 0) {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'sales'), {
                        customerId: custRef.id, item, amount: total, type: 'sale', date: new Date().toISOString()
                    });
                }
                if (paid > 0) {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'sales'), {
                        customerId: custRef.id, item: 'Boshlang\'ich to\'lov', amount: paid, type: 'payment', date: new Date().toISOString()
                    });
                }
                closeModal('customerModal');
                ['custName', 'custPhone', 'custFirstItem', 'custTotalAmount', 'custPaidAmount'].forEach(id => document.getElementById(id).value = '');
            } catch (e) { console.error(e); }
        };

        document.getElementById('confirmPaymentBtn').onclick = async () => {
            if (!auth.currentUser || !activeCustomerId) return;
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            if (!amount) return;

            try {
                const c = customersData.find(x => x.id === activeCustomerId);
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'sales'), {
                    customerId: activeCustomerId, item: 'Qarz to\'lovi', amount, type: 'payment', date: new Date().toISOString()
                });
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'customers', activeCustomerId), {
                    totalDebt: (c.totalDebt || 0) - amount
                });
                closeModal('paymentModal');
            } catch (e) { console.error(e); }
        };

        window.renderAll = () => {
            const search = document.getElementById('customerSearch').value.toLowerCase();
            const totalQarz = customersData.reduce((a, b) => a + (b.totalDebt || 0), 0);
            document.getElementById('totalDebts').innerText = totalQarz.toLocaleString() + " so'm";
            
            const todayStr = new Date().toISOString().split('T')[0];
            const todayS = salesData.filter(s => s.date.startsWith(todayStr) && s.type === 'sale').reduce((a, b) => a + b.amount, 0);
            document.getElementById('todaySales').innerText = todayS.toLocaleString() + " so'm";

            document.getElementById('customerList').innerHTML = customersData
                .filter(c => c.name.toLowerCase().includes(search))
                .sort((a,b) => (b.totalDebt || 0) - (a.totalDebt || 0))
                .map(c => `
                <tr class="border-t hover:bg-gray-50 transition">
                    <td class="p-4 font-bold text-gray-800">${c.name}</td>
                    <td class="p-4 text-gray-500">${c.phone || '-'}</td>
                    <td class="p-4 font-bold ${c.totalDebt > 0 ? 'text-red-600' : 'text-gray-400'}">${(c.totalDebt || 0).toLocaleString()}</td>
                    <td class="p-4 text-right">
                        <button onclick="openModal('paymentModal', '${c.id}')" class="bg-blue-600 text-white px-4 py-1 rounded-lg text-xs font-bold active:scale-95 transition">To'lov</button>
                    </td>
                </tr>`).join('');

            document.getElementById('salesHistoryTable').innerHTML = salesData.sort((a,b) => new Date(b.date) - new Date(a.date)).map(s => {
                const c = customersData.find(x => x.id === s.customerId);
                return `
                <tr class="border-t text-sm">
                    <td class="p-4 text-gray-400 font-mono">${new Date(s.date).toLocaleDateString()}</td>
                    <td class="p-4 font-medium text-gray-700">${c ? c.name : 'O\'chirilgan'}</td>
                    <td class="p-4 text-gray-600">${s.item}</td>
                    <td class="p-4 font-bold ${s.type === 'sale' ? 'text-red-600' : 'text-green-600'}">${s.amount.toLocaleString()}</td>
                    <td class="p-4"><span class="${s.type === 'sale' ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600'} px-2 py-1 rounded-md font-black text-[10px] uppercase">${s.type === 'sale' ? 'Nasiya' : 'To\'lov'}</span></td>
                </tr>`;
            }).join('');
            updateChart();
        };

        function updateChart() {
            const ctx = document.getElementById('salesChart')?.getContext('2d');
            if (!ctx) return;
            const last7Days = [...Array(7)].map((_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - (6 - i));
                return d.toISOString().split('T')[0];
            });
            const chartData = last7Days.map(date => salesData.filter(s => s.date.startsWith(date) && s.type === 'sale').reduce((a, b) => a + b.amount, 0));
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { 
                    labels: last7Days.map(d => d.split('-').slice(1).reverse().join('.')), 
                    datasets: [{ 
                        label: 'Kunlik savdo', 
                        data: chartData, 
                        borderColor: '#2563eb', 
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.3,
                        borderWidth: 3
                    }] 
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
            });
        }
    </script>
</body>
</html>

